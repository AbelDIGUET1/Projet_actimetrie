//----------------Init Couleur----------------------//

#define BLACK       0x0000
#define VIOLET      0x925A
#define CYAN        0x67FC
#define WHITE       0xFFFF
#define RED         0xF800
#define BLUE         0x011F
#define ORANGE       0xFAC0
#define YELLOW       0xFF20
#define GREEN       0x0F00
#define DARKGREEN       0x2AC8
//---------------Init Ecran OLED-----------------//

#include <Adafruit_GFX.h>    // Core graphics library
#include <Adafruit_ST7789.h> // Hardware-specific library for ST7789
#include <SPI.h>

#define TFT_CS         10
#define TFT_RST        9 
#define TFT_DC         8

Adafruit_ST7789 display = Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST);


// 'Icone ordi allumé', 50x50px
const unsigned char epd_bitmap_Icone_ordi_allum_ [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xfe, 
  0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x4f, 0xff, 0xff, 0xfc, 0x80, 0x00, 
  0x00, 0x9f, 0xff, 0xff, 0xfe, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 
  0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 
  0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 
  0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 
  0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 
  0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 0x40, 0x00, 0x00, 0xbf, 0xff, 0xff, 0xff, 
  0x40, 0x00, 0x00, 0x9f, 0xff, 0xff, 0xfe, 0x40, 0x00, 0x00, 0x47, 0xff, 0xff, 0xf8, 0x80, 0x00, 
  0x00, 0x30, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


const int epd_bitmap_allArray_LEN1= 1;
const unsigned char* epd_bitmap_allArray1[1] = {
  epd_bitmap_Icone_ordi_allum_
};

// 'Icone ordi éteint', 50x50px
const unsigned char epd_bitmap_Icone_ordi__teint [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xfe, 
  0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x80, 0x00, 
  0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 
  0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 
  0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 
  0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 
  0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 
  0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
  0x40, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x80, 0x00, 
  0x00, 0x30, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const int epd_bitmap_allArray_LEN2= 1;
const unsigned char* epd_bitmap_allArray2[1] = {
  epd_bitmap_Icone_ordi__teint
};

// 'Icone bluetooth allumé', 50x50px
const unsigned char epd_bitmap_Icone_bluetooth_allum_ [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x30, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x03, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x43, 
  0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x06, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x1b, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x18, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x07, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x30, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x1b, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x0c, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x63, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x43, 0x02, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x03, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
  0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const int epd_bitmap_allArray_LEN3 = 1;
const unsigned char* epd_bitmap_allArray3[1] = {
  epd_bitmap_Icone_bluetooth_allum_
};

// 'Icone MEAB', 50x50px
const unsigned char epd_bitmap_Icone_MEAB [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 
  0x00, 0x00, 0x00, 0xf8, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x78, 0x00, 0x00, 0x00, 
  0x07, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x18, 0x17, 
  0x80, 0x03, 0x00, 0x00, 0x00, 0x30, 0x3b, 0xc0, 0x01, 0x80, 0x00, 0x00, 0x60, 0x90, 0xf0, 0x00, 
  0xc0, 0x00, 0x00, 0xe0, 0xc0, 0x60, 0x00, 0xe0, 0x00, 0x00, 0xc0, 0x60, 0x48, 0x00, 0x60, 0x00, 
  0x01, 0x81, 0x00, 0x1c, 0x00, 0x30, 0x00, 0x01, 0x87, 0x80, 0x09, 0xc0, 0x30, 0x00, 0x03, 0x0d, 
  0x80, 0x03, 0xe0, 0x18, 0x00, 0x03, 0x18, 0xc0, 0x07, 0xf8, 0x18, 0x00, 0x03, 0x30, 0x60, 0x07, 
  0xf0, 0x18, 0x00, 0x06, 0x30, 0x60, 0x07, 0x0f, 0x0c, 0x00, 0x06, 0x10, 0x60, 0x0e, 0x78, 0x0c, 
  0x00, 0x06, 0x00, 0xc0, 0x0c, 0xc0, 0x0c, 0x00, 0x06, 0x01, 0x00, 0x03, 0x80, 0x0c, 0x00, 0x06, 
  0x00, 0x00, 0x1e, 0x00, 0x0c, 0x00, 0x06, 0x00, 0x3f, 0xf0, 0x40, 0x0c, 0x00, 0x06, 0x00, 0x60, 
  0x00, 0xc0, 0x0c, 0x00, 0x06, 0x01, 0xc0, 0x00, 0xc0, 0x0c, 0x00, 0x06, 0x07, 0x10, 0x00, 0xf0, 
  0x0c, 0x00, 0x03, 0x0c, 0x30, 0xf0, 0xc0, 0x18, 0x00, 0x03, 0x08, 0xf0, 0xf0, 0xf0, 0x18, 0x00, 
  0x03, 0x00, 0x30, 0xf0, 0xc0, 0x18, 0x00, 0x01, 0x80, 0xf0, 0xf0, 0xf0, 0x30, 0x00, 0x01, 0x80, 
  0x30, 0x00, 0xc0, 0x30, 0x00, 0x00, 0xc0, 0xf0, 0x00, 0xf0, 0x60, 0x00, 0x00, 0xe0, 0x30, 0x00, 
  0xc0, 0xe0, 0x00, 0x00, 0x60, 0x30, 0x00, 0xc0, 0xc0, 0x00, 0x00, 0x30, 0x1f, 0xff, 0x81, 0x80, 
  0x00, 0x00, 0x18, 0x0f, 0xff, 0x03, 0x00, 0x00, 0x00, 0x0e, 0x04, 0x92, 0x0e, 0x00, 0x00, 0x00, 
  0x07, 0x04, 0x92, 0x1c, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0xf8, 
  0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


const unsigned char* epd_bitmap_allArray4[1] = {
  epd_bitmap_Icone_MEAB
};

//---------------Init Module RTC-----------------//

#include "GravityRtc.h"
#include "Wire.h"

GravityRtc rtc;     //RTC Initialization


//---------------Init NRF24L01------------------------//

#include <SPI.h>
#include "printf.h"
#include "RF24.h"

#define CE_PIN 5
#define CSN_PIN 6

RF24 radio(CE_PIN, CSN_PIN);

uint8_t address[][6] = { "1Node", "2Node" };
bool radioNumber = 1;  // 0 uses address[0] to transmit, 1 uses address[1] to transmit
bool role = true;  // true = TX role, false = RX role

//---------------Init Accelerometre-----------------//

#include <Wire.h>
#include <Adafruit_MMA8451.h>
#include <Adafruit_Sensor.h>
Adafruit_MMA8451 mma = Adafruit_MMA8451();

//----------------Init Variables--------------------//

float x=0;  //Valeur d'accélération selon x
float x_final=0;
float y=0;  //Valeur d'accélération selon y
float y_final=0;
float z=0;  //Valeur d'accélération selon z
float z_final=0;
float IndiceMVBracelet=0; //Indice de mouvement du bracelet
float IndiceMVMontre=0; //Indice de mouvement de la montre
float ValeurP=0;
float ValeurAntP=0;
int rtcAntMin=0;
int rtcAntHour=0;
uint16_t color;

// Position et dimensions du rectangle extérieur (blanc)
int PositionX = 20; // Position X
int PositionY = 130; // Position Y
int Largeur = 200; // Largeur
int Hauteur = 40; // Hauteur Hau
int arrondi = 10; // Rayon des coins arrondis
int Ep = 3; // Épaisseur

// --- Affichage de la barre de batterie ---
int x_bat = 155; // Position X en haut à droite
int y_bat = 6;  // Position Y en haut
int Lar_bat = 75; // Largeur
int Hau_bat = 34; // Hauteur
int arrondi_bat = 12; // Rayon des coins arrondis
int Ep_bat = 2; // Épaisseur

float Lar_int = 0;
int x_int = 0;
int y_int = 0;
int Hau_int = 0;
int arrondi_inter = 0;

void setup(void) {

  //----------------Setup Serial--------------------//

  Serial.begin(9600);

  //----------------Setup Oled--------------------//
  pinMode(3, OUTPUT);
  display.init(240, 240); // Initialisation pour un écran 240x240
  display.setRotation(0); // Orientation de l'écran
  display.fillScreen(ST77XX_BLACK); // Efface l'écran en noir
  analogWrite(3, 0);  
  delay(100);
  display.setCursor(10, 70);
  display.setTextColor(CYAN);
  display.setTextSize(3);
  display.print("Stroke Watch");
  display.setCursor(60, 105);
  display.setTextSize(2);
  display.setTextColor(VIOLET);
  display.print("Since 2025");
  for (int i=0; i<=255;i++){
    analogWrite(3, i);  
    delay(14);
  }
  display.fillRect(0, 165, 240, 75, BLACK);
  display.setCursor(46, 165);
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.print("Chargement");
  delay(350);
  
  //----------------Setup RTC--------------------//
  rtc.setup();
  rtc.adjustRtc(F(__DATE__), F(__TIME__));

  //----------------Setup NRF24L01--------------------//
  if (!radio.begin()) {
    display.setCursor(50, 165);
    display.setTextSize(2);
    display.setTextColor(RED);
    display.print("Bluetooth Error");
    while (1) {}  // hold in infinite loop

  }

  radio.setPALevel(RF24_PA_LOW);
  radio.setPayloadSize(sizeof(IndiceMVBracelet)); // float datatype occupies 4 bytes
  radio.openReadingPipe(1, address[0]);
  radio.startListening();  // put radio in RX mode

  display.fillRect(0, 165, 240, 75, BLACK);
  display.setCursor(50, 165);
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.print("Bluetooth Ok");
  delay(350);

  //----------------Setup Accelerometre--------------------//
  if (! mma.begin()) {
    display.fillRect(0, 165, 240, 75, BLACK);
    display.setCursor(30, 165);
    display.setTextSize(2);
    display.setTextColor(RED);
    display.print("Accelerometer Error");
    delay(350);
    while (1);
  }
  mma.setRange(MMA8451_RANGE_4_G);

  display.fillRect(0, 165, 240, 75, BLACK);
  display.setCursor(30, 165);
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.print("Accelerometer Ok");
  delay(350);
  display.fillRect(0, 165, 240, 75, BLACK);
  display.setCursor(30, 165);
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.print("Configuration Ok");
  delay(500);

  display.fillScreen(ST77XX_BLACK);

  //----------------Setup Affichage Ecran--------------------//

  // Dessiner le cadre extérieur blanc
  for (int i = 0; i < Ep; i++) {
      display.drawRoundRect(PositionX + i, PositionY + i, Largeur - 2 * i, Hauteur - 2 * i, arrondi, ST77XX_WHITE);
  }

  // Dessiner le cadre extérieur blanc pour la batterie
  for (int i = 0; i < Ep_bat; i++) {
      display.drawRoundRect(x_bat + i, y_bat + i, Lar_bat - 2 * i, Hau_bat - 2 * i, arrondi_bat, ST77XX_WHITE);
  }

  display.drawBitmap(0,0,epd_bitmap_Icone_ordi_allum_ ,50,50,ST77XX_WHITE);
  display.drawBitmap(50,0,epd_bitmap_Icone_bluetooth_allum_,50,50,ST77XX_WHITE);
  display.drawBitmap(95,0,epd_bitmap_Icone_MEAB,50,50,0x780F);


  rtc.read();
  rtcAntHour=rtc.hour;
  rtcAntMin=rtc.minute;
  display.setTextSize(3);
  display.setCursor(80, 75);
  display.setTextColor(WHITE);
  display.print(rtc.hour);
  display.setTextSize(3);
  display.setCursor(130, 75);
  display.setTextColor(WHITE);
  display.print(rtc.minute);
  display.setCursor(115, 75);
  display.print(":");
}

void loop() {
  
  //-----------Lecture de l'heure------------------//

  rtc.read();

  if((rtc.hour)!=rtcAntHour){
    display.fillRect(79, 74, 40, 40, BLACK);
    display.setTextSize(3);
    display.setCursor(80, 75);
    display.setTextColor(WHITE);
    display.print(rtc.hour);
    rtcAntHour=rtc.hour;
  }
  if((rtc.minute)!=rtcAntMin){
    display.fillRect(129, 74, 40, 40, BLACK);
    display.setTextSize(3);
    display.setCursor(130, 75);
    display.setTextColor(WHITE);
    display.print(rtc.minute);
    rtcAntMin=rtc.minute;
  }


  //----------Lecture des valeurs de l'accéléromètre-------------//
  mma.read();
  if(abs(mma.x)>(x+200) || abs(mma.x)<(x-200)){
    x=abs(mma.x);
    x_final=x_final+(x/8312);
    IndiceMVMontre=IndiceMVMontre+ x_final;
  }
  if(abs(mma.y)>(y+200) || abs(mma.y)<(y-200)){
    y=abs(mma.y);
    y_final=y_final+(y/8312);
    IndiceMVMontre=IndiceMVMontre+ y_final;
  }
  if(abs(mma.z)>(z+200) || abs(mma.z)<(z-200)){
    z=abs(mma.z);
    z_final=z_final+(z/8312);
    IndiceMVMontre=IndiceMVMontre+ z_final;
  }     

  //----------------Réception données bluetooth----------------//
  uint8_t pipe;
  if (radio.available(&pipe)) {              // is there a payload? get the pipe number that received it
    uint8_t bytes = radio.getPayloadSize();  // get the size of the payload
    radio.read(&IndiceMVBracelet, bytes); 
    //Serial.println("Well Received");          // fetch payload from FIFO
  }

  if(IndiceMVBracelet == 0){
    ValeurP=0;
  }
  if((IndiceMVMontre/IndiceMVBracelet)>1 && IndiceMVBracelet !=0){
    ValeurP=1;
  }else{
    ValeurP=(IndiceMVMontre/IndiceMVBracelet);
  }

  //-----------------------Ecran-------------------------//
  const char* message;

  if(ValeurP>(ValeurAntP+0.1) || ValeurP<(ValeurAntP-0.1)){
    display.fillRect(0, 180, 240, 75, BLACK);
    if(ValeurP<=0.2){
      message = "Bouge !";
      color = RED;

    }
    if(ValeurP<=0.4 && ValeurP>=0.2){
      message = "Insuffisant";
      color = ST77XX_ORANGE;

    }
    if(ValeurP<=0.6 && ValeurP>=0.4){
      message = "Encore";
      color = ST77XX_YELLOW;

    }
    if(ValeurP<=0.8 && ValeurP>=0.6){
      message = "C'est bien";
      color = ST77XX_GREEN;

    }
    if(ValeurP<=1 && ValeurP>=0.8){
      message = "Excellent";
      color = 0x03E0;

    }
    display.fillRoundRect(x_int, y_int, Largeur-6, Hau_int, arrondi_inter, BLACK);
    ValeurAntP=ValeurP;
    int16_t text_x, text_y;
    uint16_t text_Lar, text_Hau;
    display.setTextSize(3);
    display.getTextBounds(message, 0, 0, &text_x, &text_y, &text_Lar, &text_Hau);
    int text_x_centre = (240 - text_Lar) / 2;
    int text_y_centre = 190;
    display.setCursor(text_x_centre, text_y_centre);
    display.setTextColor(ST77XX_WHITE);
    display.print(message);
    
    Lar_int = Largeur * ValeurP;
    x_int = PositionX + Ep;
    y_int = PositionY + Ep;
    Hau_int = Hauteur - 2 * Ep;
    arrondi_inter = 5;

    // Dessiner la barre d'activité
    display.fillRoundRect(x_int, y_int, Lar_int, Hau_int, arrondi_inter, color);


  }



}

